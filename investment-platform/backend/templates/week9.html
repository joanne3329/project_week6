{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">ğŸŒŠ æŠ•è³‡å†’éšªä¹‹æ—…</h2>
  <p class="text-muted text-center">ä¸€è·¯é—–é—œï¼Œå…± 10 é¡Œï¼Œæœ€å¾Œæ­æ›‰ä½ æ˜¯å“ªç¨®å†’éšªè§’è‰²èˆ‡æŠ•è³‡é¢¨æ ¼ï¼</p>

  <!-- é€²åº¦æ¢ + æé¾ -->
  <div class="progress-wrapper" style="position: relative; max-width: 600px; margin: auto;">
    <div id="dino-wrapper" style="position: absolute; top: 50%; left: 0; transform: translateY(-50%); display: flex; align-items: center; font-size: 2rem;">
      <span id="dino" class="jump">ğŸ¦•</span>
      <span id="progress-text" style="font-size: 0.9rem; margin-left: 6px;">0%</span>
    </div>
    <div class="progress mb-4" style="height: 20px;">
      <div id="progress-bar"
           class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 0%"></div>
    </div>
  </div>

  <!-- é¡Œç›®å¡ç‰‡ï¼ˆåªæœ‰åœ¨æ²’æœ‰çµæœæ™‚æ‰é¡¯ç¤ºï¼‰ -->
  {% if result is not defined or not result %}
  <div id="quiz-container" class="d-flex justify-content-center">
    {% for q in range(1,11) %}
    <div class="card question-card p-4 mb-5 animate__animated" style="display:none;">
      <div class="card-body text-center">
        <h5 class="card-title">ç¬¬ {{ q }} é—œ</h5>
        {% if q == 1 %}
          <p class="card-text">ğŸŒ©ï¸ æš´é¢¨é›¨ä¾†è¥²ï¼å¸‚å ´æš´è·Œ 20%ï¼Œä½ æœƒæ€éº¼è¾¦ï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="ğŸ¢ åœä¸‹èˆªç¨‹ï¼Œä¿è­·æœ¬é‡‘">ğŸ¢ åœä¸‹èˆªç¨‹ï¼Œä¿è­·æœ¬é‡‘</button>
          <button class="answer-btn" data-value="3" data-text="ğŸ¦Š è§€å¯Ÿé¢¨å‘ï¼Œèª¿æ•´èˆªå‘">ğŸ¦Š è§€å¯Ÿé¢¨å‘ï¼Œèª¿æ•´èˆªå‘</button>
          <button class="answer-btn" data-value="5" data-text="ğŸ¦ è¿é¢¨å‰è¡Œï¼Œç›¸ä¿¡æš´é¢¨é›¨å¾Œæœ‰å¯¶è—">ğŸ¦ è¿é¢¨å‰è¡Œï¼Œç›¸ä¿¡æš´é¢¨é›¨å¾Œæœ‰å¯¶è—</button>
        {% elif q == 2 %}
          <p class="card-text">ğŸ¯ é€™è¶Ÿå†’éšªï¼Œä½ çš„é¦–è¦ç›®æ¨™æ˜¯ï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="å®‰å…¨æŠµé”æ¸¯å£">å®‰å…¨æŠµé”æ¸¯å£</button>
          <button class="answer-btn" data-value="3" data-text="æ²¿é€”æ¢ç´¢è³‡æº">æ²¿é€”æ¢ç´¢è³‡æº</button>
          <button class="answer-btn" data-value="5" data-text="å°‹æ‰¾å‚³èªªå¯¶è—">å°‹æ‰¾å‚³èªªå¯¶è—</button>
        {% elif q == 3 %}
          <p class="card-text">ğŸ—¡ï¸ å¥½å‹éçµ¦ä½ ã€Œé«˜é¢¨éšªç¥å™¨ã€ï¼Œä½ æœƒï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="å©‰æ‹’ï¼ˆå¤ªå±éšªï¼‰">å©‰æ‹’ï¼ˆå¤ªå±éšªï¼‰</button>
          <button class="answer-btn" data-value="3" data-text="å°å¿ƒè©¦ç”¨">å°å¿ƒè©¦ç”¨</button>
          <button class="answer-btn" data-value="5" data-text="å…¨åŠ›ä½¿ç”¨">å…¨åŠ›ä½¿ç”¨</button>
        {% elif q == 4 %}
          <p class="card-text">ğŸ´â€â˜ ï¸ ä½ é‡åˆ°æµ·ç›œè¦æ±‚åˆä½œï¼Œä½ æœƒï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="æ‹’çµ•åˆä½œ">æ‹’çµ•åˆä½œ</button>
          <button class="answer-btn" data-value="3" data-text="å°é¡åˆä½œ">å°é¡åˆä½œ</button>
          <button class="answer-btn" data-value="5" data-text="å¤§è†½åˆä½œ">å¤§è†½åˆä½œ</button>
        {% elif q == 5 %}
          <p class="card-text">ğŸ¤ ä½ è¦æŒ‘é¸ä¸€ä½èˆªæµ·ä¼™ä¼´ï¼Œä»–æ˜¯ï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="è€æ°´æ‰‹ï¼ˆä¿å®ˆï¼‰">è€æ°´æ‰‹ï¼ˆä¿å®ˆï¼‰</button>
          <button class="answer-btn" data-value="3" data-text="è°æ˜å•†äººï¼ˆå¹³è¡¡ï¼‰">è°æ˜å•†äººï¼ˆå¹³è¡¡ï¼‰</button>
          <button class="answer-btn" data-value="5" data-text="å†’éšªå‹‡è€…ï¼ˆæ¿€é€²ï¼‰">å†’éšªå‹‡è€…ï¼ˆæ¿€é€²ï¼‰</button>
        {% elif q == 6 %}
          <p class="card-text">ğŸ’° æµ·ä¸Šæ¼‚æµ®é‡‘å¹£ï¼Œä½ æœƒï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="ä¸æ’¿ï¼Œæ€•æœ‰é™·é˜±">ä¸æ’¿ï¼Œæ€•æœ‰é™·é˜±</button>
          <button class="answer-btn" data-value="3" data-text="æ’¿ä¸€é»è©¦è©¦">æ’¿ä¸€é»è©¦è©¦</button>
          <button class="answer-btn" data-value="5" data-text="å…¨æ’¿èµ·ä¾†ï¼">å…¨æ’¿èµ·ä¾†ï¼</button>
        {% elif q == 7 %}
          <p class="card-text">âš“ ä½ çš„èˆªæµ·ç¶“é©—åƒæ˜¯ï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="æ–°æ‰‹æ°´æ‰‹">æ–°æ‰‹æ°´æ‰‹</button>
          <button class="answer-btn" data-value="3" data-text="æœ‰ç¶“é©—çš„æ°´æ‰‹">æœ‰ç¶“é©—çš„æ°´æ‰‹</button>
          <button class="answer-btn" data-value="5" data-text="è€ç·´èˆ¹é•·">è€ç·´èˆ¹é•·</button>
        {% elif q == 8 %}
          <p class="card-text">ğŸ—ºï¸ æµ·åœ–ä¸Šå‡ºç¾æœªçŸ¥å³¶å¶¼ï¼Œä½ æœƒï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="ç¹é“è€Œè¡Œ">ç¹é“è€Œè¡Œ</button>
          <button class="answer-btn" data-value="3" data-text="å°å¿ƒé è¿‘">å°å¿ƒé è¿‘</button>
          <button class="answer-btn" data-value="5" data-text="ç«‹åˆ»ç™»å³¶æ¢éšª">ç«‹åˆ»ç™»å³¶æ¢éšª</button>
        {% elif q == 9 %}
          <p class="card-text">âš–ï¸ èˆ¹ä¸Šè³‡æºæœ‰é™ï¼Œä½ æœƒï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="å„ªå…ˆå­˜ç³§ï¼Œç¢ºä¿å®‰å…¨">å„ªå…ˆå­˜ç³§ï¼Œç¢ºä¿å®‰å…¨</button>
          <button class="answer-btn" data-value="3" data-text="å¹³å‡åˆ†é…">å¹³å‡åˆ†é…</button>
          <button class="answer-btn" data-value="5" data-text="å…¨åŠ›é€ èˆ¹ï¼Œå¿«é€Ÿæ¢ç´¢">å…¨åŠ›é€ èˆ¹ï¼Œå¿«é€Ÿæ¢ç´¢</button>
        {% elif q == 10 %}
          <p class="card-text">ğŸ”¥ æ—…ç¨‹æœ€å¾Œï¼Œä½ èƒ½æ‰¿å—çš„æœ€å¤§æå¤±æ˜¯ï¼Ÿ</p>
          <button class="answer-btn" data-value="1" data-text="5% ä»¥å…§">5% ä»¥å…§</button>
          <button class="answer-btn" data-value="3" data-text="10% - 20%">10% - 20%</button>
          <button class="answer-btn" data-value="5" data-text="30% ä»¥ä¸Š">30% ä»¥ä¸Š</button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- éš±è—è¡¨å–® -->
  <form method="POST" action="/topic/9/test" id="quiz-form">
    {% for i in range(1,11) %}
      <input type="hidden" name="q{{ i }}" id="q{{ i }}">
      <input type="hidden" name="a{{ i }}" id="a{{ i }}">
    {% endfor %}
    <button type="submit" id="submit-btn" 
            class="btn btn-primary px-5 py-2" 
            style="display:none;">
      âœ¨ æŸ¥çœ‹ä½ çš„å†’éšªè§’è‰²
    </button>
  </form>

  {% if result %}
  <div class="mt-5 p-4 text-center shadow rounded animate__animated animate__fadeInUp" style="background:#fafafa;">
    <h4>ğŸ¯ ä½ çš„å†’éšªè§’è‰²</h4>
    <h2>{{ result[0] }}</h2>
    <p class="mt-3">{{ result[2] }}</p>
    <hr>
    <h5>ğŸ“‹ ä½ çš„å›ç­”å›é¡§</h5>
    <div id="review-container" style="max-width:600px; margin:auto;">
      {% for i in range(1,11) %}
      <div class="review-card shadow p-3 rounded animate__animated" style="display:none;">
        <h6>ç¬¬ {{ i }} é¡Œ</h6>
        <p><b>é¡Œç›®ï¼š</b> {{ questions[i] }}</p>
        <p><b>ä½ çš„é¸æ“‡ï¼š</b> {{ review_answers["a" ~ i] }}</p>
      </div>
      {% endfor %}
      <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-outline-secondary" id="prev-review">â¬… ä¸Šä¸€é¡Œ</button>
        <button class="btn btn-outline-warning" id="next-review">ä¸‹ä¸€é¡Œ â¡</button>
      </div>
    </div>
    <hr>
    <h5>ğŸ“Š é…ç½®æ¯”ä¾‹</h5>
    <div style="max-width:600px; margin:auto;">
      <canvas id="allocationChart" style="height:350px;"></canvas>
    </div>
    <div class="mt-4 d-flex justify-content-center">
      <a href="/topic/9/test" class="btn btn-success px-4 py-2">ğŸ”„ é‡æ–°æ¸¬é©—</a>
    </div>
  </div>
  {% endif %}
</div>

<!-- CSS -->
<style>
.progress { background-color: #e0e0e0; border-radius: 20px; overflow: hidden; }
.progress-bar { transition: width 0.6s ease-in-out; background: linear-gradient(90deg, #42a5f5, #81c784); }
.question-card { max-width: 600px; width: 100%; margin: auto; border-radius: 15px; background: #fff; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
.answer-btn { display: block; width: 100%; margin: 8px 0; padding: 10px 16px; font-size: 15px; border-radius: 8px; border: 1px solid #90caf9; background-color: #e3f2fd; color: #0d47a1; transition: all 0.3s ease; }
.answer-btn:hover { background-color: #bbdefb; border-color: #64b5f6; transform: scale(1.02); }
.answer-btn:active, .answer-btn.selected { background-color: #42a5f5; color: #fff; border-color: #1e88e5; }
.jump { animation: jump 1s infinite; }
@keyframes jump { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
#submit-btn { display: block; margin: 20px auto 0 auto; }
</style>

<!-- JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const cards = document.querySelectorAll(".question-card");
  const total = cards.length;
  let current = 0;

  function showCard(index, animationIn="animate__fadeInRight") {
    cards.forEach((c, i) => {
      c.style.display = (i === index ? "block" : "none");
      if (i === index) {
        c.classList.remove("animate__fadeOutLeft","animate__fadeInRight");
        c.classList.add(animationIn);
      }
    });
    let percent = (index===0)?0:(index*10);
    const bar=document.getElementById("progress-bar");
    const dinoWrapper=document.getElementById("dino-wrapper");
    const progressText=document.getElementById("progress-text");
    bar.style.width=percent+"%";
    progressText.innerText=percent+"%";
    let barWidth=document.querySelector(".progress-wrapper").offsetWidth;
    let dinoPos=(percent/100)*barWidth;
    dinoWrapper.style.left=dinoPos+"px";
  }

  document.querySelectorAll(".answer-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const value=btn.dataset.value, text=btn.dataset.text;
      const qid="q"+(current+1), aid="a"+(current+1);
      document.getElementById(qid).value=value;
      document.getElementById(aid).value=text;
      cards[current].classList.add("animate__fadeOutLeft");
      setTimeout(()=>{
        current++;
        if(current<total){ showCard(current,"animate__fadeInRight"); }
        else{
          document.getElementById("progress-bar").style.width="100%";
          document.getElementById("progress-text").innerText="100%";
          document.getElementById("submit-btn").style.display="block";
          cards[current-1].style.display="none";
          document.getElementById("dino-wrapper").style.left="100%";
        }
      },400);
    });
  });
  showCard(0);

  {% if result %}
  let reviewIndex=0;
  const reviews=document.querySelectorAll(".review-card");
  function showReview(i){ reviews.forEach((c,idx)=>{c.style.display=(i===idx)?"block":"none";}); }
  showReview(0);
  document.getElementById("prev-review").addEventListener("click",()=>{if(reviewIndex>0){reviewIndex--;showReview(reviewIndex);}});
  document.getElementById("next-review").addEventListener("click",()=>{if(reviewIndex<reviews.length-1){reviewIndex++;showReview(reviewIndex);}});
  const ctx=document.getElementById('allocationChart').getContext('2d');
  new Chart(ctx,{type:'doughnut',data:{labels:{{ allocation.keys()|list|tojson|safe }},datasets:[{data:{{ allocation.values()|list|tojson|safe }},backgroundColor:['#64b5f6','#81c784','#ffd54f','#ba68c8'],borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});
  {% endif %}
</script>
{% endblock %}
